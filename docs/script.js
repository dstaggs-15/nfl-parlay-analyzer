// Simple logistic model web implementation
//
// This script reads a fixed set of team ratings (point differentials per game)
// for the 2025 NFL season and exposes functions to compute the win
// probability for a given matchup.  It also provides a basic UI for users
// to input parlays and see the estimated probabilities.  Results are
// approximate and should not be used for wagering.

// Ratings generated by parlay_predictor.py from games.csv (season 2025)
const ratings = {
  IND: 6.764705882352941,
  SEA: 6.0588235294117645,
  LA: 5.764705882352941,
  DET: 4.882352941176471,
  KC: 4.470588235294118,
  NE: 4.294117647058823,
  DEN: 3.6470588235294117,
  HOU: 3.176470588235294,
  BUF: 3.0,
  GB: 2.176470588235294,
  LAC: 1.4705882352941178,
  DAL: 1.411764705882353,
  JAX: 1.2352941176470587,
  SF: 1.0588235294117647,
  BAL: 0.23529411764705882,
  PHI: 0.11764705882352941,
  MIA: -0.11764705882352941,
  ATL: -0.7058823529411765,
  CHI: -0.7058823529411765,
  TB: -0.7647058823529411,
  CLE: -0.8823529411764706,
  NYG: -1.0588235294117647,
  PIT: -1.5294117647058822,
  WAS: -1.5294117647058822,
  NYJ: -1.7058823529411764,
  TEN: -1.7647058823529411,
  MIN: -2.588235294117647,
  NO: -2.6470588235294117,
  CAR: -2.823529411764706,
  CIN: -3.235294117647059,
  ARI: -3.588235294117647,
  LV: -4.294117647058823
};

// Logistic function with scale parameter k
function logistic(x, k = 0.25) {
  return 1.0 / (1.0 + Math.exp(-k * x));
}

// Predict the probability that teamA beats teamB
function predict(teamA, teamB, k = 0.25) {
  const ratingA = ratings[teamA];
  const ratingB = ratings[teamB];
  if (ratingA === undefined) {
    throw new Error(`Team ${teamA} is not recognized.`);
  }
  if (ratingB === undefined) {
    throw new Error(`Team ${teamB} is not recognized.`);
  }
  const diff = ratingA - ratingB;
  return logistic(diff, k);
}

// Dynamically add a new leg input row
function addLegRow() {
  const container = document.getElementById('legs-container');
  const legDiv = document.createElement('div');
  legDiv.className = 'leg';
  const inputA = document.createElement('input');
  inputA.type = 'text';
  inputA.placeholder = 'Betting team (e.g., IND)';
  const inputB = document.createElement('input');
  inputB.type = 'text';
  inputB.placeholder = 'Opponent (e.g., SEA)';
  const removeBtn = document.createElement('button');
  removeBtn.textContent = 'Remove';
  removeBtn.className = 'remove-leg';
  removeBtn.addEventListener('click', () => {
    container.removeChild(legDiv);
  });
  legDiv.appendChild(inputA);
  legDiv.appendChild(inputB);
  legDiv.appendChild(removeBtn);
  container.appendChild(legDiv);
}

// Gather input legs from DOM and compute probabilities
function calculate() {
  const legDivs = document.querySelectorAll('#legs-container .leg');
  const resultsDiv = document.getElementById('individual-results');
  const combinedP = document.getElementById('combined-result');
  const resultsSection = document.getElementById('results');
  resultsDiv.innerHTML = '';
  combinedP.textContent = '';
  let combinedProb = 1.0;
  let hadError = false;
  legDivs.forEach((div) => {
    const inputs = div.getElementsByTagName('input');
    const teamA = inputs[0].value.trim().toUpperCase();
    const teamB = inputs[1].value.trim().toUpperCase();
    if (!teamA || !teamB) {
      return;
    }
    try {
      const p = predict(teamA, teamB);
      combinedProb *= p;
      const pPercent = (p * 100).toFixed(1);
      const legResult = document.createElement('p');
      legResult.textContent = `${teamA} beats ${teamB}: ${pPercent}%`;
      resultsDiv.appendChild(legResult);
    } catch (err) {
      const errMsg = document.createElement('p');
      errMsg.style.color = 'red';
      errMsg.textContent = err.message;
      resultsDiv.appendChild(errMsg);
      hadError = true;
    }
  });
  if (!hadError) {
    const combinedPercent = (combinedProb * 100).toFixed(1);
    combinedP.textContent = `Combined parlay probability: ${combinedPercent}%`;
  }
  resultsSection.style.display = 'block';
}

// Initialize the page
document.addEventListener('DOMContentLoaded', () => {
  // add the first leg row by default
  addLegRow();
  document.getElementById('add-leg').addEventListener('click', addLegRow);
  document.getElementById('calculate').addEventListener('click', calculate);
});
